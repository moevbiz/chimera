<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chimera</title>
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>
    <header>
        <img src="./images/Zvc2dtW.png" alt="" width="200">
        <nav id="filters">
            <button data-filter-value="All" class="active">All</button>
            <button data-filter-value="Link">Link</button>
            <button data-filter-value="Text">Text</button>
            <button data-filter-value="Image">Image</button>
            <button data-filter-value="Attachment">Attachment</button>
        </nav>
    </header>
    <br>
    <div id="container">

    </div>
    <br>
    <div style="height: 2em">
        <button id="load-more" class="loading" style="width: 100%">
            Load More
        </button>
        <span class="loading-indicator" style="text-align: center;">
            Loadingâ€¦
        </span>
    </div>
</body>
<script>
    const container = document.getElementById('container')
    const filters = document.getElementById('filters')
    const classes = [];

    const moreBtn = document.getElementById('load-more')

    const perPage = 13
    let noButtonListeners = true
    let doneLoading = false

    document.addEventListener('DOMContentLoaded', function() {
        init();
    })

    moreBtn.addEventListener('click', function(e) {
        //reset element count before next request
        countEls = 0;
        var filterValue = filters.querySelector('button.active').innerHTML
        request(this.dataset.loadPage, filterValue)
        this.classList.add('loading')
    })

    let currentPage = 1;

    function init() {
        request(currentPage);
    }

    // pageNum = number of next page, classFilter = which type of content to show
    function request(pageNum, classFilter = 'All') {

        moreBtn.classList.add('loading')

        if (doneLoading) return

        if (countEls > perPage) {
            return countEls
        } else {
            if (classFilter != 'All') {
                console.log(`filtering by ${classFilter}`)
                // return
            }   
            fetch(`api?page=${pageNum}&per=${perPage}`)
            .then(res => res.json())
            .then(data => {
                currentPage++

                appendToContainer(data.contents, classFilter)

                // only add button listeners once
                if (noButtonListeners) {
                    addButtonListeners()
                }

                console.log(`appended ${data.contents.length} nodes`)

                if (data.contents.length < perPage) {
                    moreBtn.style.display = 'none'
                    console.log('no more data to fetch')
                    return doneLoading = true
                } else {
                    moreBtn.dataset.loadPage = currentPage
                    moreBtn.classList.remove('loading')
                }
            })
            .catch(error => console.error(error))
        }   

    }

    var countEls = 0;

    // elements = which elements to show
    function appendToContainer(data, elements) {

        if (elements != 'All') {
            if (countEls < perPage) {
                request(currentPage, elements);
            } else {
                return countEls;
            }
        }

        data.map((item) => {
            console.log(item);

            var itemEl = document.createElement('article');
            itemEl.classList.add('block');
            itemEl.dataset.class = item.class;
            itemEl.id = item.id;

            // hide element if a filtered request is made
            // and the element class is not the requested class
            // count elements shown on page
            if (elements != 'All') {
                if (itemEl.dataset.class !== elements) {
                    itemEl.classList.add('hidden');
                } else {
                    countEls++;
                    console.log(`new elements: ${countEls}, stopping at: ${perPage}`)
                }
            }

            if (item.class == 'Text') {
                itemEl.innerHTML = `
                    <span class="block__class">
                        ${item.class}
                    </span>
                    ${item.title}
                    <i>${item.content}</i>
                `
            }

            else 
            if (item.class == 'Image') {
                itemEl.innerHTML = `
                    <img src="${item.image.large.url}">
                `
            }

            else
            if (item.class == 'Attachment') {
                itemEl.innerHTML = `
                    <span class="block__class">
                        ${item.class}
                    </span>
                    <a href="${item.attachment.url}">
                        ${item.title}
                    </a>
                    <i>${item.description}</i>
                `
            }

            else
            if (item.class == 'Link') {
                if (item.title.length < 1) {
                    var name = item.source.url
                } else {
                    var name = item.title
                }
                itemEl.innerHTML = `
                    <span class="block__class">
                        ${item.class}
                    </span>
                    <a href="${item.source.url}">
                        ${name}
                    </a>
                    <i>${item.description}</i>
                `
            }
            // only append non-channel nodes for now :~)
            if (item.class != 'Channel' && item.class != 'Media') container.appendChild(itemEl);
        });
    }

    function addButtonListeners() {

        noButtonListeners = false

        const blocks = document.querySelectorAll('.block');

        filters.querySelectorAll('button').forEach((button) => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                //reset element count
                countEls = 0;
                var value = this.dataset.filterValue;
                filters.querySelectorAll('button').forEach((button) => {
                    button.classList.remove('active');
                })
                this.classList.add('active');
                if (value == 'All') {
                    blocks.forEach((block) => {
                        block.classList.remove('hidden');
                    })
                } else {
                    filterExistingBlocks(value);
                    if (countEls > perPage) return
                    request(currentPage, value)
                }
            })
        })

    }

    function filterExistingBlocks(val) {
        const blocks = document.querySelectorAll('.block');
        countEls = container.querySelectorAll(`[data-class="${val}`).length
        console.log(`found ${countEls} existing nodes`)
        blocks.forEach((block) => {
            if (block.dataset.class != val) {
                block.classList.add('hidden')
            } else {
                block.classList.remove('hidden')
            }
        });
    }

</script>
</html>